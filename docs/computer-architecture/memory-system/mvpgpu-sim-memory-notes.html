<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory subsystem notes &mdash; ggangliu-doc v0.01 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/_variables.scss?v=7050c318" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f6c7d6a8"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/custom.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ggangliu-doc
          </a>
              <div class="version">
                v0.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ai-deep-learning.html">AI (Deep Learning)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ai-embedded.html">AI Embedded</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software.html">Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulator.html">Simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../compiler.html">Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../computer-architecture.html">Computer Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdl.html">Hardware Description Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../open-source-project.html">Open Source Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../work-related.html">Work-related</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ggangliu-doc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Memory subsystem notes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="memory-subsystem-notes">
<h1>Memory subsystem notes<a class="headerlink" href="#memory-subsystem-notes" title="Link to this heading"></a></h1>
<blockquote>
<div><p>本文的目标是Profiling存储子系统的各单元在MVP v3.0设计中的大小</p>
</div></blockquote>
<section id="mvp-memory-subsystem">
<h2>MVP Memory subsystem<a class="headerlink" href="#mvp-memory-subsystem" title="Link to this heading"></a></h2>
<p>MVP Memory subsystem简图如下：
<img alt="mvp-memory-subsystem" src="../../_images/mvp-memory-subsystem.png" /></p>
<p>对Memory的访问应该有如下几条路径：</p>
<ul class="simple">
<li><p>FE阶段从L1 Instruction Cache中取指令</p></li>
<li><p>RF阶段从寄存器中读取数据</p></li>
<li><p>EX阶段，如果指令是st/ld指令，则需要访问L1 Data Cache或者Local Memory</p></li>
</ul>
<p>下面针对上述几条路径，分别进行解析</p>
<ul class="simple">
<li><p>FE</p></li>
<li><p>RF</p></li>
<li><p>EX</p></li>
<li><p>func_exec_inst函数在EX阶段用来产生memory访问请求</p></li>
</ul>
<p>SP通过该函数调用warp指令的generate_mem_access函数来处理访存操作</p>
</section>
<section id="register-file-size">
<h2>Register File Size<a class="headerlink" href="#register-file-size" title="Link to this heading"></a></h2>
<p>寄存器文件的大小跟编译器和线程数量相关，如果每线程占用的寄存器数量扩大一倍，也将间接影响local memory的大小。这部分需要编译器一起进行分析确认</p>
<section id="regisrer-file-cache">
<h3>Regisrer File Cache<a class="headerlink" href="#regisrer-file-cache" title="Link to this heading"></a></h3>
<p>?</p>
</section>
</section>
<section id="l1-inst-cache-size">
<h2>L1 Inst Cache Size<a class="headerlink" href="#l1-inst-cache-size" title="Link to this heading"></a></h2>
<p>L1 Inst Cache是一个直接映射类型的缓存。每个Block的大小是32bit（但实际占用36bit），一共有2048个Block，总大小是9KB. 这里为了提升Cache的性能增加cache bandwidth，采用了multibanked cache技术，将cache拆分为4个bank。</p>
<p>L1I Cache主要是为了缓存SP上线程指令，提升流水线运行效率，避免stall。SP中L1I设计为9KB总容量，data mem和tag mem分别有4个bank，mem每个bank有512个blocks，tag每个bank有64个tag。每个tag对应在mem中有8个32bits的数据。miss的情况下会从XI读取数据，一个地址一次会取8个32bits数据。hit的情况下直接从data mem取指令。</p>
<p><img alt="l1ictage" src="../../_images/2023-07-12_152920.png" />
<img alt="l1i" src="../../_images/2023-07-12_151629.png" />
<img alt="tagandcache" src="../../_images/2023-07-12_160140.png" /></p>
<p>Bank: 4 =&gt; 2-bit
Cache entries: 512 =&gt; 9-bit
Cache index:   6-bit + 3-bit
Data: 32-bit</p>
<p>miss后DRAM的访问请求能够取回256-bit的数据，填充8个entries，每个32bit.</p>
<p>Tag: 20-bit
Tag entries: 64 = &gt; 6-bit
Tag index: 6-bit
tag content: 20-bit</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>&lt;nsets&gt;:&lt;bsize&gt;:&lt;assoc&gt;,&lt;rep&gt;:&lt;wr&gt;:&lt;alloc&gt;:&lt;wr_alloc&gt;,&lt;mshr&gt;:&lt;N&gt;:&lt;merge&gt;,&lt;mq&gt;<span class="o">}</span>
</pre></div>
</div>
<p><font color='#00f'> 1路组相连，Block=32bit, 2048个Block，4个Bank
gpgpu_cache:il1 N:2048:36:1,L:R:f:N:L,S:2:48,4 </font></p>
<p>-gpgpu_cache:il1 m_L1I_config.m_config_string</p>
<p>-gpgpu_inst_fetch_throughput 4
-gpgpu_cache:il1 N:64:128:16,L:R:f:N:L,S:2:48,4</p>
<p>N:64:128:16,  L:R:f:N:L,      S:2:48,   10:10,  4
“%c:%u:%u:%u, %c:%c:%c:%c:%c, %c:%u:%u, %u:%u,  %u”,
&amp;ct, &amp;m_nset, &amp;m_line_sz, &amp;m_assoc,
&amp;rp, &amp;wp, &amp;ap, &amp;wap, &amp;sif,
&amp;mshr_type, &amp;m_mshr_entries, &amp;m_mshr_max_merge,
&amp;m_miss_queue_size, &amp;m_result_fifo_entries, &amp;m_data_port_width);</p>
<p>ct=N
m_nset=64
m_line_sz=128
m_assoc=16</p>
<p>rp = L
wp = R
ap = f
wap = N
sif = L</p>
<p>mshr_type = S
m_mshr_entries = 2
m_assoc = 48</p>
<p>m_miss_queue_size = 10
m_result_fifo_entries = 10</p>
<p>m_data_port_width = 4</p>
<p>所有只读cache的配置都使用cache_config来定义
mutable cache_config m_L1I_config</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;rep&gt;</span></code> L,F       m_replacement_policy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;wr&gt;</span></code>  R,B,T,E,L m_write_policy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;alloc&gt;</span></code> m,f,s   m_alloc_policy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;wr_alloc&gt;</span></code></p></li>
</ul>
<section id="l1-inst-cache">
<h3>L1 Inst Cache初始化流程<a class="headerlink" href="#l1-inst-cache" title="Link to this heading"></a></h3>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>flowchart LR
GPGPUSim_Init --&gt; ctx.gpu_init --&gt; m_gpu_config.init --&gt; m_sp_config.init --&gt; m_L1I_config.init
</pre></div>
</div>
<p>gpgpu_n_mem_read_global = 6144
gpgpu_n_mem_write_global = 12288
gpgpu_n_load_insn  = 589824
gpgpu_n_store_insn = 491520</p>
<p>traffic_breakdown_coretomem[GLOBAL_ACC_R] = 49152 {8:6144,}
traffic_breakdown_coretomem[GLOBAL_ACC_W] = 491520 {40:12288,}
traffic_breakdown_coretomem[INST_ACC_R] = 6144 {8:768,}
traffic_breakdown_memtocore[GLOBAL_ACC_R] = 983040 {40:24576,}
traffic_breakdown_memtocore[GLOBAL_ACC_W] = 98304 {8:12288,}
traffic_breakdown_memtocore[INST_ACC_R] = 122880 {40:3072,}</p>
</section>
<section id="what-is-stream-cache">
<h3>What is stream cache<a class="headerlink" href="#what-is-stream-cache" title="Link to this heading"></a></h3>
<p>Refer to <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
</section>
<section id="optimization">
<h3>Optimization<a class="headerlink" href="#optimization" title="Link to this heading"></a></h3>
<p>编译器能否插入特定指令帮助处理器提前预取数据，来提升cache的命中率？</p>
</section>
</section>
<section id="l1-data-cache-size">
<h2>L1 Data Cache Size<a class="headerlink" href="#l1-data-cache-size" title="Link to this heading"></a></h2>
<p>L1 Data Cache是一个直接映射类型的缓存。每个Block的大小是32bit，一共有512个Block，总大小是2KB. 这里为了提升Cache的性能增加cache bandwidth，采用了multibanked cache技术，将cache拆分为8个bank。当前实现中记录32个miss。</p>
<p>L1D的主要作用是为SP上运行的线程缓存数据。当前的设计，data_mem内部有4个h和4个l的ram块。每个块的含有64个32bit的数据项。h和l根据数据地址的[0]bit来决定，0表示h,1表示l。L1D的数据来自于XI，OCC或RBUS。XI进来的数据每个时钟周期只有32bit，</p>
<p><img alt="l1d" src="../../_images/2023-07-12_161413.png" /></p>
<p>Entries: 64 =&gt; 6-bit</p>
<p>-gpgpu_cache:dl1 m_L1D_config.m_config_string</p>
<p><font color='#00f'> 1路组相连，Block=32bit, 512个Block，8个Bank
gpgpu_cache:dl1 N:512:32:1,L:R:f:N:L,S:2:48,4 </font></p>
<p>gpgpu_n_load_insn  = 589824 589824/98304=6</p>
<p>gpgpu_n_store_insn = 491520 491520/98304=5</p>
<p>gpgpu_stall_shd_mem[global_mem][resource_stall] = 18432
gpgpu_stall_shd_mem[local_mem][resource_stall] = 459056</p>
</section>
<section id="local-memory-size">
<h2>Local Memory Size<a class="headerlink" href="#local-memory-size" title="Link to this heading"></a></h2>
<p><img alt="local memory" src="../../_images/local-memory.png" />
32KB = 4KB x 8 bank
4KB = 1024 x 32 /8</p>
</section>
<section id="l2-cache-size">
<h2>L2 Cache Size<a class="headerlink" href="#l2-cache-size" title="Link to this heading"></a></h2>
</section>
<section id="dram">
<h2>DRAM<a class="headerlink" href="#dram" title="Link to this heading"></a></h2>
<section id="dram-model-config">
<h3>dram model config<a class="headerlink" href="#dram-model-config" title="Link to this heading"></a></h3>
<p>-gpgpu_l2_rop_latency 160
-dram_latency 100</p>
<p>-gpgpu_dram_partition_queues 64:64:64:64
-gpgpu_perf_sim_memcpy 1
-gpgpu_memory_partition_indexing 0</p>
<p>-gpgpu_dram_scheduler 1
-gpgpu_frfcfs_dram_sched_queue_size 64
-gpgpu_dram_return_queue_size 192</p>
<p>m_memory_partition_unit
m_memory_sub_partition</p>
</section>
<section id="gddr6">
<h3>GDDR6<a class="headerlink" href="#gddr6" title="Link to this heading"></a></h3>
<p>-gpgpu_n_mem_per_ctrlr 1
-gpgpu_dram_buswidth 2
-gpgpu_dram_burst_length 16
-dram_data_command_freq_ratio 4
-gpgpu_mem_address_mask 1
-gpgpu_mem_addr_mapping dramid&#64;8;00000000.00000000.00000000.00000000.0000RRRR.RRRRRRRR.RBBBCCCC.BCCSSSSS</p>
<p>//Use the same GDDR5 timing, scaled to 3500MHZ
-gpgpu_dram_timing_opt “nbk=16:CCD=4:RRD=10:RCD=20:RAS=50:RP=20:RC=62:
CL=20:WL=8:CDLR=9:WR=20:nbkgrp=4:CCDL=4:RTPL=4”</p>
<p>//select lower bits for bnkgrp to increase bnkgrp parallelism
-dram_bnk_indexing_policy 0
-dram_bnkgrp_indexing_policy 1</p>
<p>//-dram_seperate_write_queue_enable 1
//-dram_write_queue_size 64:56:32</p>
</section>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Link to this heading"></a></h2>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.cl.cam.ac.uk/research/srg/projects/fairisle/bluebook/12/scache/node2.html">https://www.cl.cam.ac.uk/research/srg/projects/fairisle/bluebook/12/scache/node2.html</a></p>
</aside>
</aside>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ggangliu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>